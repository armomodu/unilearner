generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER MODEL
// ============================================
model User {
  id         String   @id @default(cuid())
  email      String   @unique
  name       String?
  supabaseId String   @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  blogs      Blog[]
  writingStyles WritingStyle[]
  
  @@index([supabaseId])
  @@map("users")
}

// ============================================
// BLOG MODEL
// ============================================
model Blog {
  id          String     @id @default(cuid())
  title       String
  slug        String     @unique
  content     String     @db.Text
  contentType String     @default("rich")
  richContent Json?
  htmlCache   String?    @db.Text
  excerpt     String?    @db.Text
  status      BlogStatus @default(GENERATING)
  
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  writingStyleId String?
  writingStyle WritingStyle? @relation(fields: [writingStyleId], references: [id], onDelete: SetNull)
  
  generation  BlogGeneration?
  sources     Source[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  publishedAt DateTime?
  
  @@index([userId, status])
  @@index([slug])
  @@index([publishedAt])
  @@index([status])
  @@index([contentType])
  @@map("blogs")
}

// ============================================
// BLOG GENERATION TRACKING MODEL
// ============================================
model BlogGeneration {
  id               String           @id @default(cuid())
  blogId           String           @unique
  blog             Blog             @relation(fields: [blogId], references: [id], onDelete: Cascade)
  writingStyleId   String?
  writingStyle     WritingStyle?    @relation(fields: [writingStyleId], references: [id], onDelete: SetNull)
  
  status           GenerationStatus @default(PENDING)
  currentStep      String?
  
  searchComplete   Boolean          @default(false)
  searchData       Json?
  searchStartedAt  DateTime?
  searchCompletedAt DateTime?
  
  researchComplete Boolean          @default(false)
  researchData     Json?
  researchStartedAt DateTime?
  researchCompletedAt DateTime?
  
  writerComplete   Boolean          @default(false)
  writerStartedAt  DateTime?
  writerCompletedAt DateTime?
  
  // Performance metrics
  totalDurationMs  Int?             // Total generation time in milliseconds
  searchDurationMs Int?             // Search agent duration
  researchDurationMs Int?           // Research agent duration  
  writerDurationMs Int?             // Writer agent duration
  
  error            String?          @db.Text
  retryCount       Int              @default(0)
  
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  completedAt      DateTime?        // When generation fully completed
  
  @@index([status, updatedAt])
  @@index([blogId])
  @@map("blog_generations")
}

// ============================================
// SOURCE MODEL
// ============================================
model Source {
  id        String   @id @default(cuid())
  blogId    String
  blog      Blog     @relation(fields: [blogId], references: [id], onDelete: Cascade)
  
  url       String
  title     String
  excerpt   String?  @db.Text
  relevance Float?
  
  createdAt DateTime @default(now())
  
  @@index([blogId])
  @@map("sources")
}

// ============================================
// WRITING STYLES
// ============================================
model WritingStyle {
  id           String    @id @default(cuid())
  slug         String    @unique
  name         String
  description  String?
  systemPrompt String    @db.Text @map("system_prompt")
  microPrompt  String?   @db.Text @map("micro_prompt")
  isDefault    Boolean   @default(false) @map("is_default")
  userId       String?   @map("user_id")
  user         User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  blogs        Blog[]
  generations  BlogGeneration[]
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt      @map("updated_at")
  
  @@index([userId])
  @@index([slug])
  @@map("writing_styles")
}

// ============================================
// ENUMS
// ============================================
enum BlogStatus {
  GENERATING  // Being created by agents
  DRAFT       // Ready for review/editing
  PUBLISHED   // Live on public site
}

enum GenerationStatus {
  PENDING     // Queued for processing
  SEARCHING   // Search agent running
  RESEARCHING // Research agent running
  WRITING     // Writer agent running
  COMPLETED   // Successfully completed
  FAILED      // Failed with error
}
